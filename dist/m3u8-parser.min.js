/*! @name m3u8-parser @version 4.2.0 @license Apache-2.0 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.m3u8Parser={})}(this,function(t){"use strict";var e={M3U:/^#EXTM3U/,VERSION:/^#EXT-X-VERSION:?([0-9.]*)?/,INF:/^#EXTINF:?([0-9\.]*)?,?(.*)?$/,BYTERANGE:/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/,DISCONTINUITY:/^#EXT-X-DISCONTINUITY$/,KEY:/^#EXT-X-KEY:?(.*)$/,MAP:/^#EXT-X-MAP:?(.*)$/,PROGRAM_DATE_TIME:/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/,TARGETDURATION:/^#EXT-X-TARGETDURATION:?([0-9.]*)?/,MEDIA_SEQUENCE:/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/,DISCONTINUITY_SEQUENCE:/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/,ENDLIST:/^#EXT-X-ENDLIST/,PLAYLIST_TYPE:/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/,START:/^#EXT-X-START:?(.*)$/,MEDIA:/^#EXT-X-MEDIA:?(.*)$/,STREAM_INF:/^#EXT-X-STREAM-INF:?(.*)$/},n=function(t){for(var e,n=t.split(new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')),r={},i=n.length;i--;)""!==n[i]&&((e=/([^=]*)=(.*)/.exec(n[i]).slice(1))[0]=e[0].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^['"](.*)['"]$/g,"$1"),r[e[0]]=e[1]);return r},r={M3U:function(t,e){return t},VERSION:function(t,e){return e[1]&&(t.version=parseInt(e[1],10)),t},INF:function(t,e){return e[1]&&(t.duration=parseFloat(e[1])),e[2]&&(t.title=e[2]),t},BYTERANGE:function(t,e){return e[1]&&(t.length=parseInt(e[1],10)),e[2]&&(t.offset=parseInt(e[2],10)),t},DISCONTINUITY:function(t,e){return t},KEY:function(t,e){return e[1]&&(t.attributes=n(e[1]),t.attributes.IV&&("0x"===t.attributes.IV.substring(0,2).toLowerCase()&&(t.attributes.IV=t.attributes.IV.substring(2)),t.attributes.IV=t.attributes.IV.match(/.{8}/g),t.attributes.IV[0]=parseInt(t.attributes.IV[0],16),t.attributes.IV[1]=parseInt(t.attributes.IV[1],16),t.attributes.IV[2]=parseInt(t.attributes.IV[2],16),t.attributes.IV[3]=parseInt(t.attributes.IV[3],16),t.attributes.IV=new Uint32Array(t.attributes.IV))),t},MAP:function(t,e){if(e[1]){var r=n(e[1]);if(r.URI&&(t.uri=r.URI),r.BYTERANGE){var i=r.BYTERANGE.split("@"),u=i[0],a=i[1];t.byterange={},u&&(t.byterange.length=parseInt(u,10)),a&&(t.byterange.offset=parseInt(a,10))}}return t},PROGRAM_DATE_TIME:function(t,e){return e[1]&&(t.dateTimeString=e[1],t.dateTimeObject=new Date(e[1])),t},TARGETDURATION:function(t,e){return e[1]&&(t.duration=parseInt(e[1],10)),t},MEDIA_SEQUENCE:function(t,e){return e[1]&&(t.number=parseInt(e[1],10)),t},DISCONTINUITY_SEQUENCE:function(t,e){return e[1]&&(t.number=parseInt(e[1],10)),t},ENDLIST:function(t,e){return t},PLAYLIST_TYPE:function(t,e){return e[1]&&(t.playlistType=e[1]),t},START:function(t,e){return e[1]&&(t.attributes=n(e[1]),t.attributes["TIME-OFFSET"]=parseFloat(t.attributes["TIME-OFFSET"]),t.attributes.PRECISE=/YES/.test(t.attributes.PRECISE)),t},MEDIA:function(t,e){return e[1]&&(t.attributes=n(e[1])),t},STREAM_INF:function(t,e){if(e[1]){if(t.attributes=n(e[1]),t.attributes.RESOLUTION){var r=t.attributes.RESOLUTION.split("x"),i={};r[0]&&(i.width=parseInt(r[0],10)),r[1]&&(i.height=parseInt(r[1],10)),t.attributes.RESOLUTION=i}t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes["PROGRAM-ID"]&&(t.attributes["PROGRAM-ID"]=parseInt(t.attributes["PROGRAM-ID"],10))}return t}},i={M3U:function(t,e){return t},VERSION:function(t,e){return t.version=e.version||1,t},COMMENT:function(t,e){return t.comments.push(e),t},UNKOWN:function(t,e){return t.unknown.push(e),t}},u={INF:function(t,e,n){return void 0===n.duration&&(n.duration=t.targetDuration),e.duration=n.duration||.01,t},BYTERANGE:function(t,e,n){return"length"in n&&(e.byterange={length:n.length,offset:n.offset||0}),t},DISCONTINUITY:function(t,e,n){return e.discontinuity=!0,e.timeline++,t.discontinuityStarts.push(t.segments.length-1),t},KEY:function(t,e,n){return n.attributes?"NONE"===n.attributes.METHOD?(delete e.key,t):(e.key={method:n.attributes.METHOD||"AES-128",uri:n.attributes.URI},void 0!==n.attributes.IV&&(e.key.iv=n.attributes.IV),t):t},MAP:function(t,e,n){return e.map={uri:n.uri,byterange:n.byterange},t},PROGRAM_DATE_TIME:function(t,e,n){return void 0===t.dateTimeString&&(t.dateTimeString=n.dateTimeString,t.dateTimeObject=n.dateTimeObject),e.dateTimeString=n.dateTimeString,e.dateTimeObject=n.dateTimeObject,t},URI:function(t,e,n){return t.targetDuration&&!e.duration&&(e.duration=t.targetDuration),e.uri=n.uri,t}},a={TARGETDURATION:function(t,e){if(!isFinite(e.duration)||e.duration<0)throw new Error("invalid taget duration");return t.targetDuration=e.duration,t},MEDIA_SEQUENCE:function(t,e){if(!isFinite(e.number))throw new Error("invalid media sequence");return t.mediaSequence=e.number,t},DISCONTINUITY_SEQUENCE:function(t,e){if(!isFinite(e.number))throw new Error("invalid discontinuity sequence");return t.discontinuitySequence=e.number,t},ENDLIST:function(t){return t.endList=!0,t},PLAYLIST_TYPE:function(t,e){return/VOD|EVENT/.test(e.playlistType)?(t.playlistType=e.playlistType,t):t},START:function(t,e){return!e.attributes||isNaN(e.attributes["TIME-OFFSET"])?t:(t.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE},t)}},s=function(t,e,n){return t.mediaSequence=0,t.discontinuitySequence=0,e.filter(function(t){return!!a[t.key]}).forEach(function(e){return a[e.key](t,e)}),function(t,e,n){return t.segments=[],t.discontinuityStarts=[],e.filter(function(t){return!!u[t.key]}).forEach(function(e){0===t.segments.length&&t.segments.push({timeline:t.discontinuitySequence});var n=t.segments.length-1,r=t.segments[n];if(r.uri){var i=r.key,a=r.map;r={timeline:r.timeline},i&&(r.key=i),a&&(r.map=a),t.segments.push(r)}return u[e.key](t,r,e)}),t}(t,e)};function o(){return(o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}var E={MEDIA:function(t,e){if(!(e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME))return t;var n=t.mediaGroups[e.attributes.TYPE];n[e.attributes["GROUP-ID"]]=n[e.attributes["GROUP-ID"]]||{};var r=n[e.attributes["GROUP-ID"]],i={default:/yes/i.test(e.attributes.DEFAULT)};return i.default?i.autoselect=!0:i.autoselect=/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(i.language=e.attributes.LANGUAGE),e.attributes.URI&&(i.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(i.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(i.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(i.forced=/yes/i.test(e.attributes.FORCED)),r[e.attributes.NAME]=i,t},STREAM_INF:function(t,e){t.streams.push({});var n=t.streams.length,r=t.streams[n-1];return r.attributes||(r.attributes={}),o(r.attributes,e.attributes),t},URI:function(t,e){var n=t.streams.length;return 0===n&&(t.streams.push({}),n++),t.streams[n-1].uri=e.uri,t}},T="#EXTM3U",c="#EXT-X-VERSION:",I="#EXTINF:",f="#EXT-X-BYTERANGE:",A="#EXT-X-DISCONTINUITY",S="#EXT-X-KEY",p="#EXT-X-MAP",N="#EXT-X-PROGRAM-DATE-TIME:",b="#EXT-X-TARGETDURATION:",m="#EXT-X-MEDIA-SEQUENCE:",O="#EXT-X-DISCONTINUITY-SEQUENCE:",R="#EXT-X-ENDLIST",D="#EXT-X-PLAYLIST-TYPE:",d="#EXT-X-START:",l="#EXT-X-MEDIA:",y="#EXT-X-STREAM-INF:",g=function(t){return T},M=function(t){return""+c+t.version},U={MEDIA:{type:function(t){return"TYPE="+t},uri:function(t){return'URI="'+t+'"'},groupId:function(t){return'GROUP-ID="'+t+'"'},language:function(t){return'LANGUAGE="'+t+'"'},name:function(t){return'NAME="'+t+'"'},default:function(t){return"DEFAULT="+(t?"YES":"NO")},autoselect:function(t){return"AUTOSELECT="+(t?"YES":"NO")},forced:function(t){return"FORCED="+(t?"YES":"NO")},instreamId:function(t){return'INSTREAM-ID="'+t+'"'},characteristics:function(t){return'CHARACTERISTICS="'+t+'"'}},STREAM_INF:{BANDWIDTH:function(t){return"BANDWIDTH="+t},"AVERAGE-BANDWIDTH":function(t){return"AVERAGE-BANDWIDTH="+t},CODECS:function(t){return'CODECS="'+t+'"'},RESOLUTION:function(t){return"RESOLUTION="+t},"FRAME-RATE":function(t){return"FRAME-RATE="+t},"HDCP-LEVEL":function(t){return"HDCP-LEVEL="+t},AUDIO:function(t){return'AUDIO="'+t+'"'},VIDEO:function(t){return'VIDEO="'+t+'"'},SUBTITLES:function(t){return'SUBTITLES="'+t+'"'},"CLOSED-CAPTIONS":function(t){return'CLOSED-CAPTIONS="'+t+'"'}}},h=function(t){var e=[];return t.streams.forEach(function(t){var n=t.attributes,r=Object.keys(n).map(function(t){return U.STREAM_INF[t](n[t])});e.push(""+y+r.join(",")),e.push(t.uri)}),e},X=function(t){var e=[],n=t.mediaGroups;for(var r in n)for(var i in n[r]){var u=function(t){var u=n[r][i][t];u.mediaType=r,u.groupId=i,u.name=t;var a=Object.keys(u).map(function(t){return U.MEDIA[t](u[t])});e.push(""+l+a.join(","))};for(var a in n[r][i])u(a)}return e},C=Object.freeze({composeAttribute:U,composeStreams:h,composeMediaGroups:X,compose:function(t,e){return t.mediaGroups&&(e=e.concat(X(t))),e.concat(h(t))}}),v={KEY:{method:function(t){return"METHOD="+t},uri:function(t){return'URI="'+t+'"'},iv:function(t){return"IV="+t}},MAP:{uri:function(t){return'URI="'+t+'"'},byterange:function(t){return'BYTERANGE="'+t+'"'}}},P=function(t){var e=[];if(t.byterange&&e.push(""+f+t.byterange.length+"@"+t.byterange.offset),t.key){var n=Object.keys(t.key).map(function(e){return v.KEY[e](t.key[e])});e.push(""+S+n.join(","))}if(t.map){var r=Object.keys(t.map).map(function(e){return v.MAP[e](t.map[e])});e.push(""+p+r.join(","))}return t.discontinuity&&e.push(""+A),t.dateTimeString&&e.push(""+N+t.dateTimeString),e.push(""+I+t.duration),e.push(t.uri),e.join("\n")},Y={START:{timeOffset:function(t){return"TIME-OFFSET="+t},precise:function(t){return"PRECISE="+(t?"YES":"NO")}}},L=function(t){var e=t.start,n=Object.keys(e).map(function(t){return Y.START[t](e[t])});return""+d+n.join(",")},G=Object.freeze({composeAttribute:Y,composeStart:L,compose:function(t){var e=[];return t.playlistType&&e.push(""+D+t.playlistType),void 0!==t.targetDuration&&e.push(""+b+t.targetDuration),void 0!==t.mediaSequence&&e.push(""+m+t.mediaSequence),void 0!==t.discontinuitySequence&&e.push(""+O+t.discontinuitySequence),t.start&&e.push(L(t)),t.segments.length&&(e=e.concat(t.segments.map(P))),t.endList&&e.push(""+R),e.join("\n")}});t.parse=function(t,n){void 0===n&&(n={});var u=t.split("\n").map(function(t){return t.trim().replace("\r","")}).filter(function(t){return t.length}).map(function(t,n){if("#"!==t[0])return{key:"URI",uri:t};if(0!==t.indexOf("#EXT"))return{key:"COMMENT",text:t.slice(1)};var i=r,u=e;for(var a in u){var s=u[a].exec(t);if(s){var o={key:a};return i[a](o,s)}}return{key:"UNKOWN",line:t}}),a=function(t){return t.filter(function(t){return!!i[t.key]}).reduce(function(t,e){return i[e.key](t,e)},{comments:[],unknown:[]})}(u);return function(t){var e=t.filter(function(t){return"STREAM_INF"===t.key}).length,n=t.filter(function(t){return"INF"===t.key}).length;if(e&&n)throw new Error("master and media");if(!e&&!n)throw new Error("unknown");return e}(u)?function(t,e,n){return t.mediaGroups={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},t.streams=[],e.filter(function(t){return!!E[t.key]}).forEach(function(e){return E[e.key](t,e)}),t}(a,u):s(a,u)},t.compose=function(t){return function(t){return[g(t),M(t)]}(t).concat((function(t){if(t.streams&&t.segments)throw new Error("master and media");if(!t.streams&&!t.segments)throw new Error("unknown");return!!t.streams}(t)?C:G).compose(t)).join("\n")},Object.defineProperty(t,"__esModule",{value:!0})});
